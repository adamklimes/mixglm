---
title: "Case Study"
subtitle: "Contents"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Case Study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.width = 7, fig.height = 5,
  collapse = TRUE,
  comment = "#>"
)
```
This is an article illustrating the use of *mixglm* package on a case study.
For a more technical illustration of the package functionality, see 
`vignette("mixglm")` (*mixglm* has to be installed with vignettes).\
\

# Tree cover in South America
The case study replicates analyses by Hirota et 
al. (<a name="bHirota"></a>[2011](#refHirota)) and Flores et 
al. (<a name="bFlores"></a>[2024](#refFlores)). These two studies model tree cover 
for most of South America and for the Amazon respectively along 
a precipitation gradient. The used tree cover data is from 2001. Replication of the analysis here is done using tree cover for the year 2025 for the whole of South America. \
\

## Tree cover dataset
*mixglm* package provides the dataset `treeCover` which includes tree cover, 
precipitation, temperature, and predicted precipitation for the end of 21st century 
and coordinates for 5,000 data-points across South America. 

```{r dataset}
library(mixglm)

# See ?treeCover for additional information 
str(treeCover)
```

In this case study, we model the stability landscape for tropical forests and savanna alternative states along precipitation and temperature gradients. There are only a few observations with very high precipitation and very low temperature. This prevents us from estimating reliably the stability landscape for these parts of respective gradients. 
Therefore, we constrain the analyses to the well-represented parts of 
precipitation (below 4000 mm/yr) and temperature gradients (over 0°C).

```{r dataSelection}
plot(treeCover$treeCover ~ treeCover$precip, cex = 0.1, ylab = "Tree cover (%)",
  xlab = "Precipitation (mm/yr)")
abline(v = 4000, lty = 2)
plot(treeCover$treeCover ~ treeCover$temp, cex = 0.1, ylab = "Tree cover (%)",
  xlab = "Temperature (°C)")
abline(v = 0, lty = 2)
datTC <- treeCover[treeCover$precip < 4000 & treeCover$temp > 0, ] # 4860 observations
```

## Stability landscape along precipitation gradient
First, we model the stability landscape along the precipitation gradient. 
Tree cover has an upper (100%) as well as lower (0%) limit, therefore we will 
use a beta mixture rather than a Gaussian (normal). A beta-distributed variable can have values from 0 to 1 (excluding 0 and 1). Thus, we calculate the proportion of tree cover 
and shift the values slightly to make sure the dataset does not contain any 
exact zeros or ones. We also standardize predictors to 0 mean and standard 
deviation 1 to facilitate the model fit (and ensure the same effect of 
priors once we use multiple predictors). 

```{r dataPreparation}
squeeze <- function(x) x * 0.98 + 0.01
datTC$treeCoverProp <- squeeze(datTC$treeCover / 100)

st <- function(x, y = x) (x - mean(y)) / sd(y)
datTC$precipSt <- st(datTC$precip)
datTC$tempSt <- st(datTC$temp)
```

We need to specify the number of components in the mixture. We should use more
components than is the number of expected stable states because each stable 
state can be modeled using multiple components (resulting e.g. in a wider basin). 
Since the probability of each component in the mixture is estimated, unnecessary 
components will have a probability close to zero and will be effectively 
suppressed. We could select the number of components based on an Watanabe-Akaike 
information criterion (WAIC; <a name="bWatanabe"></a>[Watanabe, 2013](#refWatanabe))
by running the model with different numbers of components and selecting the 
one with the lowest WAIC. However, estimates of WAIC are sometimes unstable 
for mixture models. In conclusion, we recommend using a high number of 
components and ensure that results are not affected by adding or excluding a 
component. In this example, we use 7 components. We also limit the number of 
chains to just 2 (for illustration purposes) to make the fit quicker (the following
model fit can take up to a few hours). 
